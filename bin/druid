#!/bin/sh

usage() {
  echo ""
  echo "Usage: $0 {load|unload} specification-file"
  echo ""
}

if [ $# -lt 2 ]; then
  usage
  exit
fi

OPERATION=$1
shift

NAME=$1
shift

if [[ $NAME == *.json ]]; then
  NAME=${NAME%.*}
fi

DATA=${NAME}.json

if [ ! -f $DATA ]; then
  echo ""
  echo "specification file not found."
  echo ""
  exit
fi

URL=http://localhost:48081

CONTENT_TYPE_HDR='Content-Type:application/json'

# load from batch, compact, etc.
#curl -X POST -H "Content-Type:application/json" -d @./druid/compact.json http://localhost:48081/druid/indexer/v1/task

load() {
  curl -X POST -H $CONTENT_TYPE_HDR -d @$DATA $URL/druid/indexer/v1/supervisor
}


unload() {

  spec=$(cat $DATA | jq -r ".spec.dataSchema.dataSource | select (.!=null)")

  echo $spec

  if [ "${spec}" == "" ]; then 
    echo ""
    echo "unable to extract dataSource from spec."
    echo ""
    exit
  fi

  curl -X POST $URL/druid/indexer/v1/supervisor/${spec}/reset
  curl -X POST $URL/druid/indexer/v1/supervisor/${spec}/shutdown
}


case "${OPERATION}" in
  load)
    load
    ;;
  unload)
    unload
    ;;
  *)
    usage
esac
